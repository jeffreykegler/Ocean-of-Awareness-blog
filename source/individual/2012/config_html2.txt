A configurable HTML parser, part 2
    <p>
      <!--
      marpa_r2_html_fmt --no-added-tag-comment
      -->
      <a href="http://jeffreykegler.github.com/Ocean-of-Awareness-blog/individual/2012/config_html.html">
      My last post</a>
      introduced Marpa::R2::HTML,
      a configurable HTML parser.
      By editing
      <a href="https://gist.github.com/3901637">
      a configuration file</a>,
      the user can change
      over a very wide range,
      the variant of HTML
      that Marpa::R2::HTML parses.
      The previous post showed one of the simplest variations --
      the ability to specify the contents of new tags,
      and the context in which they can appear.
      In this post I vary
      the HTML grammar more aggressively,
      changing the contents
      of the HTML body (the
      <tt>&lt;body&gt;</tt>
      element).
    </p><h3>
      Is changing the definition of the HTML body useful?</h3><p>
      Marpa::R2::HTML allows changing the contents of all pre-existing
      element, with the exception of the highest level one --
      the
      <tt>
        &lt;html&gt;</tt>
      element itself.
      This can be more impressive than utilitarian,
      but in the case of the
      <tt>
        &lt;body&gt;</tt>
      element there is a real case to be made for allowing the
      application to choose.
    </p><h3>
      Can text appear directly in an HTML body?</h3>
    <p>
      Can text appear directly in an HTML
      <tt>
        &lt;body&gt;</tt>
      element?
      That is, must text inside an HTML
      <tt>
        &lt;body&gt;</tt>
      be part of one of its child elements,
      or can it be directly part of the contents
      of the
      <tt>
        &lt;body&gt;</tt>
      element?
    </p><p>
      If you want an
      answer strictly according to the standards,
      then you get your choice in the matter.
      According the
      <a href="http://www.w3.org/TR/1999/PR-html40-19990824/sgml/dtd.html#inline">
        HTML 4.01 Strict DTD</a>,
      the
      <tt>
        &lt;body&gt;</tt>
      contains a "block flow",
      which means that
      the answer is "No, text must be in the contents of a child element".
      Implementations of HTML were encouraged to be liberal, however,
      and in practice much of the HTML has text directly
      in
      <tt>
        &lt;body&gt;</tt>
      elements.
      Users expect their browsers is render these as the writer intended.
    </p><p>
      Recognizing existing practice,
      HTML 5 changed to require conforming implementations to
      allow text to be interspersed with the block flow,
      in what I call a "mixed flow".
      A mixed flow can directly contain blocks and text,
      as well as inline elements.
      (The inline vs. block element distinction is basic to HTML parsing.
      See my earlier post or
      <a href="http://en.wikipedia.org/wiki/HTML_element">
        the well-organized Wikipedia page on HTML elements</a>.)
    </p><h3>
      Block or mixed flow?</h3><p>
      In parsing HTML, do you want to treat the body as a block flow or a mixed flow?
      Here are some of the factors.
    </p><ul>
      <li>
        Common practice requires accepting a mixed flow.
      </li><li>
        Cautious practice suggests writing a block flow.
      </li><li>
        HTML 4.01 requires block, but suggests being liberal.
      </li><li>
        HTML 5 requires that a mixed flow be accepted.
      </li><li>
        But HTML5 also requires that the mixed flow be displayed as if it was written
	in blocks,
        suggests that explicit blocking be used to eliminate
        ambiguities.
      </li></ul>
    <h3>
      Examples</h3>
    <h4>
      Body contains block flow</h4><p>
      In the first example,
      the
      <tt>
        &lt;body&gt;</tt>,
	contains a block flow.
      This is what is specified in
      <a href="https://gist.github.com/3901637">
      the default configuration file</a>.
      Here is the pertinent line:
    </p><blockquote>
      <pre><tt>
&lt;body&gt; is *block
</tt></pre></blockquote><p>
      This line says
      that the
      <tt>
        &lt;body&gt;</tt>
      element contains a block flow (<tt>*block</tt>).
      Here the star is a sigil which suggests the repetition operator
      of DTD's and regular expressions.
      (Readers of my last post will notice I've changed the configuration
      file syntax and will,
      I hope,
      find the new format an improvement.)
    </p><p>
      For all of the examples in this post,
      the HTML will be
    </p><blockquote>
      <pre><tt>
I cannot wait for a start tag&lt;p&gt;I can
</tt></pre></blockquote><p>
      We run this through the
      <tt>marpa_r2_html_fmt --no-added-tag-comment</tt>.
      Here is the output:
    </p><blockquote>
      <pre><tt>
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;
      I cannot wait for a start tag&lt;/p&gt;&lt;p>
      I can&lt;/p&gt;&lt;/body>
&lt;/html&gt;
</tt></pre></blockquote>
The first thing the parser encounters is text
which in this example is not allowed
to occur directly in the body.
As part of being highly liberal HTML parser,
however, Marpa::R2::HTML will supply a start tag
in these situations.
(This behavior, by the way, is also configurable --
a change to the configuration file will
tell Marpa::R2::HTML not to do this.)
With its two <tt>&lt;p&gt;</tt> start tags,
one of them conjured up by the Ruby Slippers,
Marpa::R2::HTML breezes through input.
    <h4>
      Body contains mixed flow</h4>
      In the second example, we liberalize the contents of
      the <tt>&lt;body&gt;</tt> to allow a mixed flow:
    <blockquote>
      <pre><tt>
&lt;body&gt; is *mixed
</tt></pre></blockquote>
Here is the result:
    <blockquote>
      <pre><tt>
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body&gt;
    I cannot wait for a start tag&lt;p&gt;
      I can&lt;/p&gt;&lt;/body&gt;
&lt;/html&gt;
</tt></pre></blockquote>
<p>
In a mixed flow, no
second <tt>&lt;p&gt;</tt> start tag
is needed, and none is created.
Its matching end tag
(<tt>&lt;/p&gt;</tt>) also does not
have to be created.
Otherwise, all is as before.
    <h3>
      What I decided</h3>
    <p>
      Before I figured out how to make my HTML parser configurable,
      I had to make a decision.
      My first
      implementation of the
      <tt>
        html_fmt</tt>
      utility was based on Marpa::XS
      and 
      its grammar specified a mixed flow.
      When I started a new version
      of the utility
      for Marpa::R2
      I decided that it produced a more precise parse if I changed to a stricter grammar,
      leaving it to the Ruby Slippers to "loosen things up"
      when the grammar was too strict.
      This was close, I hoped, to the best of both worlds,
      so I changed.
      This second choice -- strict block-flow-body grammar and liberal Ruby Slippers --
      remains the default in the configurable version.
    </p><p>
      Now both the grammar and the Ruby Slippers are configurable.
      The user gets to decide what she wants at runtime.
    </p>
<h3>Stupid parser tricks</h3>
Marpa::R2::HTML configuration is designed to allow the parser to
range over the useful variations of HTML.
In addition,
it allows many variations which will probably find no application.
The two variations which follow do help illustrate how configuration
works, and what happens if you go wrong with it.
    <h4>
      Body contains inline flow</h4>
An inline flow cannot contain block elements,
although it can contain text and inline elements.
This is far too restrictive for the body of an HTML document,
but here is is how you'd specify it:
    <blockquote>
      <pre><tt>
&lt;body&gt; is *inline
</tt></pre></blockquote>
And here is what happens:
    <blockquote>
      <pre><tt>
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;
  &lt;body&gt;
    I cannot wait for a start tag&lt;!--
        html_fmt: Next line is cruft
      --&gt;&lt;p&gt;I can&lt;/body&gt;
&lt;/html&gt;
</tt></pre></blockquote>
Text is acceptable in an inline flow, so the first text string winds up in the
body.
But
the
<tt>&lt;p&gt;</tt>
starts a block element, and cannot be accepted.
Marpa::R2::HTML labels
the
<tt>&lt;p&gt;</tt>
as "cruft".
The rest of the input is more text,
and the parse proceeds normally.
    <h4>
      Body is empty</h4>
The final example requires the
the
      <tt>&lt;body&gt;</tt>
to be empty.
    <blockquote>
      <pre><tt>
&lt;body&gt; is *empty
</tt></pre></blockquote>
    <p>
      In the other examples, the one-line change in the configuration
      file was all that it took to do the job.
      In the case changing the
      <tt>&lt;body&gt;</tt>
      to an empty element,
      element, there's a small complication.
      The Ruby Slippers lines refer to the end tag of the
      body element:
      <tt>&lt;/body&gt;</tt>.
      The fix is simple -- just eliminate all references
      to the no-longer-existing end tag.
      (Ruby Slippers configuration is something I'll discuss in more detail
      later.)
      Here is our result:
    </p><blockquote>
      <pre><tt>
&lt;html&gt;
  &lt;head&gt;
  &lt;/head&gt;&lt;body&gt;&lt;!--
      html_fmt: Next line is cruft
    --&gt;I cannot wait for a start tag&lt;!--
      html_fmt: Next line is cruft
    --&gt;&lt;p&gt;&lt;!--
      html_fmt: Next line is cruft
    --&gt;I can&lt;/html&gt;
</tt></pre></blockquote>
<p>
The parser recognizes the empty
      <tt>&lt;body&gt;</tt>
      tag.
      But an empty
      <tt>&lt;body&gt;</tt>
      leaves the parser with no place to put other tags and text,
      so it labels all of them as "cruft".
    <h3>
      Code and comments</h3><p>
      The examples here were run using Marpa::R2 release 2.021_010.
      They are part of its test suite as <tt>html/t/cfg_fmt.t</tt>.
	</p>
      The configurable Marpa::R2::HTML does considerably more than
      can be comfortably described in a single post.
      This post is the second of a series.
      Comments on this post can be sent to the Marpa Google Group:
      <code>
        marpa-parser@googlegroups.com</code>
    </p>
